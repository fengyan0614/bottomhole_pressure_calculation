import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import os
# 导入自定义模块
from bottomhole_pressure_calculation import calculate_bottomhole_pressure_from_excel
from fracture_mode_analysis import analyze_and_plot_extension_modes, save_fracture_modes_to_excel


def main():
    # 定义文件路径
    # input_excel_path = r"C:\Users\fy\Desktop\压裂施工数据+微地震参数\MaX5126\Stage\Stage20.xlsx"
    # pressure_output_path = r"C:\Users\fy\Desktop\压裂施工数据+微地震参数\MaX5126\bottomholepressure\S20井底净压力数据.xlsx"
    # mode_result_path = r"C:\Users\fy\Desktop\压裂施工数据+微地震参数\MaX5126\Moderesults\S20裂缝延伸模式分析结果.xlsx"
    input_excel_path = r"D:\movefromHP\研究生\新疆项目-超深层页岩油压裂缝网量化评价技术\新疆油田诊断项目数据夏204\玛湖勘探开发项目部 夏204X井 压裂7队 20241103\施工\23-21\23-21.xlsx"
    pressure_output_path = r"D:\movefromHP\研究生\新疆项目-超深层页岩油压裂缝网量化评价技术\新疆油田诊断项目数据夏204\玛湖勘探开发项目部 夏204X井 压裂7队 20241103\施工\23-22\S22井底净压力数据.xlsx"
    mode_result_path = r"D:\movefromHP\研究生\新疆项目-超深层页岩油压裂缝网量化评价技术\新疆油田诊断项目数据夏204\玛湖勘探开发项目部 夏204X井 压裂7队 20241103\施工\23-22\S22裂缝延伸模式分析结果.xlsx"

    try:
        # 1. 计算井底净压力
        print("开始计算井底净压力...")
        bottomhole_pressure, time_seconds = calculate_bottomhole_pressure_from_excel(input_excel_path)

        # 验证计算结果
        if len(bottomhole_pressure) != len(time_seconds):
            raise ValueError("井底净压力与时间序列长度不匹配")

        print(f"计算完成，共获取 {len(bottomhole_pressure)} 个数据点")


        # 2. 保存原始井底净压力数据
        pressure_df = pd.DataFrame({
            '时间(秒)': time_seconds,
            '井底净压力': bottomhole_pressure
        })
        # 确保输出目录存在
        os.makedirs(os.path.dirname(pressure_output_path), exist_ok=True)
        pressure_df.to_excel(pressure_output_path, index=False)
        print(f"原始井底净压力数据已保存至: {pressure_output_path}")

        # 4. 分析裂缝延伸模式
        print("\n开始进行裂缝延伸模式判别...")
        mode_time, Y_n, n_smoothed = analyze_and_plot_extension_modes(time_seconds, bottomhole_pressure)

        # 验证分析结果
        if mode_time is not None and Y_n is not None and n_smoothed is not None:
            print("裂缝延伸模式判别完成")
            # 统计各模式数量
            mode_counts = {
                "突破屏障": np.sum(Y_n == 1),
                "缝高扩展顺利": np.sum(Y_n == 2),
                "缝高受限": np.sum(Y_n == 3),
                "缝网扩展": np.sum(Y_n == 4),
                "未定义模式": np.sum(Y_n == 0)
            }

            print("\n裂缝模式统计结果:")
            for mode, count in mode_counts.items():
                print(f"{mode}: {count} 个数据点")

            # 保存裂缝延伸模式结果
            os.makedirs(os.path.dirname(mode_result_path), exist_ok=True)
            save_success = save_fracture_modes_to_excel(
                mode_time,
                Y_n,
                n_smoothed,
                mode_result_path
            )
            if save_success:
                print(f"裂缝延伸模式结果已保存至: {mode_result_path}")

            # 显示图表
            plt.show()
        else:
            print("裂缝延伸模式判别失败")

    except Exception as e:
        print(f"处理过程中发生错误: {str(e)}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()
